---
title: "Masterthesis script KMI "
author: "Heleen Van Ransbeeck"
date: "2023-02-27"
output:
  html_document: default
  pdf_document: default
---

# Data inladen

```{r}
Baits<-read.table(file = "~/GitHub/vespa_analyses/Input/Baits_useful.txt", header=TRUE, sep="\t", na.strings=c(""," ","NA"))

Flights<-read.table(file = "~/GitHub/vespa_analyses/Input/Flights_KMI.txt", header=TRUE, sep="\t", na.strings=c(""," ","NA"))

Nests<-read.table(file = "~/GitHub/vespa_analyses/Input/Nests_useful.txt", header=TRUE, sep="\t", na.strings=c(""," ","NA"))

Shortind_incomplete<-read.table(file = "~/GitHub/vespa_analyses/Input/Shortind_incomplete.txt", header=TRUE, sep="\t", na.strings=c(""," ","NA"))

Shortpot_incomplete<-read.table(file = "~/GitHub/vespa_analyses/Input/Shortpot_incomplete.txt", header=TRUE, sep="\t", na.strings=c(""," ","NA"))

Individuals<-read.table(file = "~/GitHub/vespa_analyses/Input/Individuals.txt", header=TRUE, sep="\t", na.strings=c(""," ","NA"))

```

-incomplete wil zeggen dat de weergegevens nog niet volledig zijn. Ik
wacht hiervoor op het KMI.

# Aanpassingen datasets

```{r}
# Overbodige kolommen wegdoen, foutje in excel
Flights<-Flights[1:(length(Flights)-1)]
Shortind_incomplete<-Shortind_incomplete[1:(length(Shortind_incomplete)-2)]
Shortpot_incomplete<-Shortpot_incomplete[1:(length(Shortpot_incomplete)-2)]

#Foerageersnelheid en vliegsnelheid (m/s) toevoegen aan tabel
Flights$test_rule_of_thumb<-Flights$Distance/(Flights$Flighttime_min*60)
Shortind_incomplete$test_rule_of_thumb<-Shortind_incomplete$Distance/(Shortind_incomplete$Flighttime_min*60)
Shortpot_incomplete$test_rule_of_thumb<-Shortpot_incomplete$Distance/(Shortpot_incomplete$Flighttime_min*60)

Flights$ForagingSpeed<-Flights$Distance*2/(Flights$Flighttime_min*60)
Shortind_incomplete$ForagingSpeed<-Shortind_incomplete$Distance*2/(Shortind_incomplete$Flighttime_min*60)
Shortpot_incomplete$ForagingSpeed<-Shortpot_incomplete$Distance*2/(Shortpot_incomplete$Flighttime_min*60)


## Urbanisatiecirkels per vliegtijd toevoegen
Flights<-merge(Flights, Baits[, c("NestID", "BaitID", "Urbanisation25m", "Urbanisation50m", "Urbanisation100m")], by=c("NestID", "BaitID"), all=TRUE)
Shortind_incomplete<-merge(Shortind_incomplete, Baits[, c("NestID", "BaitID", "Urbanisation25m", "Urbanisation50m", "Urbanisation100m")], by=c("NestID", "BaitID"))
Shortpot_incomplete<-merge(Shortpot_incomplete, Baits[, c("NestID", "BaitID", "Urbanisation25m", "Urbanisation50m", "Urbanisation100m")], by=c("NestID", "BaitID"))

## Urbanisatietrajecten per vliegtijd toevoegen
Flights<-merge(Flights, Baits[, c("NestID", "BaitID", "Traject25m", "Traject50m", "Traject100m")], by=c("NestID", "BaitID"), all=TRUE)
Shortind_incomplete<-merge(Shortind_incomplete, Baits[, c("NestID", "BaitID", "Traject25m", "Traject50m", "Traject100m")], by=c("NestID", "BaitID"))
Shortpot_incomplete<-merge(Shortpot_incomplete, Baits[, c("NestID", "BaitID", "Traject25m", "Traject50m", "Traject100m")], by=c("NestID", "BaitID"))

## Gewicht individu per vliegtijd toevoegen
Flights<-merge(Flights, Individuals[, c("NestID", "BaitID","ColorInd", "Weight_ind")], by=c("NestID", "BaitID", "ColorInd"), all=TRUE)
Shortind_incomplete<-merge(Shortind_incomplete, Individuals[, c("NestID", "BaitID", "ColorInd", "Weight_ind")], by=c("NestID", "BaitID", "ColorInd"))
Shortpot_incomplete<-merge(Shortpot_incomplete, Individuals[, c("NestID", "BaitID", "ColorInd","Weight_ind")], by=c("NestID", "BaitID", "ColorInd"))

## Nesthoogte per vliegtijd toevoegen
Flights<-merge(Flights, Nests[, c("NestID", "Height")], by=c("NestID"), all=TRUE)
Shortind_incomplete<-merge(Shortind_incomplete, Nests[, c("NestID", "Height")], by=c("NestID"))
Shortpot_incomplete<-merge(Shortpot_incomplete, Nests[, c("NestID", "Height")], by=c("NestID"))

library(ggplot2)
library(ggpubr)
```

Volgende datasets zijn gecreÃ«erd:

- Flights: dataset met alle vliegtijden
- Shortind_incomplete: dataset met kortste vliegtijden per individu
- Shortpot_incomplete: dataset met kortste vliegtijden per wiekpot

**Voorstel:**
Voor het model: *Flight time ~ Distance*
zou ik de dataset vliegtijden per individu nemen (en eventueel per wiekpot?)
Omdat we hiermee de theoretische regel 1min=100m kunnen verifiÃ«ren.
De imkers nemen hiervoor altijd kortste meting

Voor modellen met weerparameters, gewicht, urbanisatie:
Hiervoor zou ik telkens de hele dataset gebruiken omdat elke meting van deze 
factoren afhangt.


# Datapunten op 2km weglaten

Deze metingen zijn nogal onzeker omdat deze waarnemingen ook van een
ander nest kunnen komen. Was op 2km afstand en in Melle zijn toch
redelijk wat nesten gevonden. Kans dat het van een nest is dat niet
gevonden werd is groot.

Als de website van Vespawatch in orde is kan ik kijken of er eventueel
een nest in de buurt is gevonden.

**Voorlopig gaan we verder met de dataset zonder de outliers in Melle**

```{r}
library(dplyr)
Flights2<-Flights %>%  filter(NestID!=1)
Shortind2_incomplete<-Shortind_incomplete %>%  filter(NestID!=1)
Shortpot2_incomplete<-Shortpot_incomplete %>%  filter(NestID!=1)

# ID maken per individu
Flights2$Individualcode <- paste(Flights2$NestID, Flights2$BaitID,Flights2$ColorInd, sep="_")
Shortind2_incomplete$Individualcode <- paste(Shortind2_incomplete$NestID, Shortind2_incomplete$BaitID,Shortind2_incomplete$ColorInd, sep="_")

```








# Data exploratie


## 1) Flight Error vs Distance

### Graphs

```{r}
ggplot(Flights2, aes(x=Distance, y=FlightError)) + geom_point(color="cadetblue2") + geom_smooth(method="lm", formula =y ~ x, se=TRUE, fullrange=FALSE, level=0.95, color="cadetblue") + ggtitle("All data")+ theme(plot.title = element_text(hjust = 0.5, size=10))
```

### Model Output

```{r}
library(lmerTest)
library(lme4)

model_errdist_all<-lmer(FlightError ~ Distance + (1|NestID) + (1|NestID:BaitID) + (1|Individualcode), na.action=na.omit, data=Flights2)
summary(model_errdist_all)
anova(model_errdist_all, ddf="Satterthwaite", type=3)
```



## 2) ForagingSpeed vs Temperature

### Graphs

Grafieken zonder outliers telkens voor de volgende datasets 

- volledige dataset 

- enkel kortste vliegtijden per individu 

- enkel kortste vliegtijden per wiekpot

```{r echo=FALSE, warning=FALSE}
plot7<-ggplot(Flights2, aes(x=Temperature_KMI, y=ForagingSpeed)) + geom_point(color="lightcoral") + geom_smooth(method="lm", formula =y ~ x, se=TRUE, fullrange=FALSE, level=0.95, color="orangered3") + ggtitle("All data")+ theme(plot.title = element_text(hjust = 0.5, size=10))

plot8<-ggplot(Shortind2_incomplete, aes(x=Temperature, y=ForagingSpeed)) + geom_point(color="lightcoral") + geom_smooth(method="lm", formula =y ~ x, se=TRUE, fullrange=FALSE, level=0.95, color="orangered3") + ggtitle("Shortest per ind.") + theme(plot.title = element_text(hjust = 0.5, size=10))

plot9<-ggplot(Shortpot2_incomplete, aes(x=Temperature, y=ForagingSpeed)) + geom_point(color="lightcoral") + geom_smooth(method="lm", formula =y ~ x,  se=TRUE, fullrange=FALSE, level=0.95, color="orangered3") + ggtitle("Shortest per jar")+ theme(plot.title = element_text(hjust = 0.5, size=10))

ggarrange(plot7, plot8, plot9 + rremove("x.text"), 
          labels = c("A", "B", "C"),
          ncol = 2, nrow = 2)
```

### Model Output

**All data**

Normality ok!

```{r}
model_temp_all<-lmer(ForagingSpeed ~ Temperature_KMI + (1|NestID) + (1|NestID:BaitID) + (1|Individualcode), na.action=na.omit, data=Flights2)
summary(model_temp_all)
anova(model_temp_all, ddf="Satterthwaite", type=3)

res<-residuals(model_temp_all)
shapiro.test(res)
qqnorm(res)
qqline(res)
```



## 3) Flight time vs Distance + Temperature

### Graph

```{r}
library(knitr)
library(kableExtra)
library("plot3D")

x <- Flights2$Distance
y <- Flights2$Temperature_KMI
z <- Flights2$Flighttime_min

fit <- lm(z ~ x + y, na.action=na.exclude)
x.pred <- seq(min(x[!is.na(x)]), max(x[!is.na(x)]), length.out = 20)
y.pred <- seq(min(y[!is.na(y)]), max(y[!is.na(y)]), length.out = 20)
xy <- expand.grid( x = x.pred, y = y.pred)
z.pred <- matrix(predict(fit, newdata = xy), 
                 nrow = 20, ncol = 20)
fitpoints <- predict(fit)

scatter3D(x, y, z, pch = 19, cex = 0.6, colvar=FALSE, col="dodgerblue3", theta = 210, phi = 10, bty="u", col.panel ="grey93", expand =0.4, col.grid = "white", xlab = "Distance", ylab = "Temperature", zlab = "Flight time", surf = list(x = x.pred, y = y.pred, z = z.pred,  
facets = TRUE, col=ramp.col(col = c("dodgerblue4", "seagreen2"), n = 100, alpha=0.8), fit = fitpoints, border="black"),main = "Flight time vs Distance + Temperature")
```


**Met plotly**

Had met deze link problemen met expand.grid
https://stackoverflow.com/questions/38331198/add-regression-plane-to-3d-scatter-plot-in-plotly


Dan maar grid dat van hierboven gebruikt, maar nu klopt er precies iets niet?
Alle datapunten liggen boven het oppervlak.

```{r}
library(plotly)
library(tidyverse)

FlightsNoNA<-Flights2 %>%  filter(Flighttime_min!="NA")
FlightsNoNA<-FlightsNoNA %>%  filter(Temperature_KMI!="NA")


fig <- plot_ly(FlightsNoNA, x = ~Distance, y = ~Temperature_KMI, z = ~Flighttime_min, size=1)
fig <- fig %>% add_markers()
fig <- fig %>% layout(scene = list(xaxis = list(title = 'Distance'),
                     yaxis = list(title = 'Temperature_KMI'),
                     zaxis = list(title = 'Flight time (min)')))


p2 <- add_trace(p = fig,
                z = z.pred,
                x = seq(2100, 0, by = -100),
                y = seq(0, 30, by = 10),
                type = "surface")
p2

```



### Model Ouput

**All data** 

Distance en temperatuur hoogsignificant

Normality niet ok!

Poisson en log/sqrt werken niet

```{r}
model_tempdist_all<-lm(Flighttime_min ~ Distance + Temperature_KMI, na.action=na.exclude, data=Flights2)
summary(model_tempdist_all)

res<-residuals(model_tempdist_all)
shapiro.test(res)
qqnorm(res)
qqline(res)
```



## 4) ForagingSpeed vs Height

### Graphs

```{r warning=FALSE}
plot10<-ggplot(Flights2, aes(x=Height, y=ForagingSpeed)) + geom_point(color="burlywood3") + geom_smooth(method="lm", formula =y ~ x, se=TRUE, fullrange=FALSE, level=0.95, color="chocolate4") + ggtitle("All data")+ theme(plot.title = element_text(hjust = 0.5, size=10))

plot11<-ggplot(Shortind2_incomplete, aes(x=Height, y=ForagingSpeed)) + geom_point(color="burlywood3") + geom_smooth(method="lm", formula =y ~ x, se=TRUE, fullrange=FALSE, level=0.95, color="chocolate4") + ggtitle("Shortest per ind.") + theme(plot.title = element_text(hjust = 0.5, size=10))

plot12<-ggplot(Shortpot2_incomplete, aes(x=Height, y=ForagingSpeed)) + geom_point(color="burlywood3") + geom_smooth(method="lm", formula =y ~ x,  se=TRUE, fullrange=FALSE, level=0.95, color="chocolate4") + ggtitle("Shortest per jar")+ theme(plot.title = element_text(hjust = 0.5, size=10))

ggarrange(plot10, plot11, plot12 + rremove("x.text"), 
          labels = c("A", "B", "C"),
          ncol = 2, nrow = 2)

```

### Model Ouput

**All data** 

Hoogsignificant

Normality niet ok!

Poisson en log/sqrt werken niet

```{r}
model_height_all<-lmer(ForagingSpeed ~ Height + (1|NestID) + (1|NestID:BaitID) + (1|Individualcode), na.action=na.omit, data=Flights2)
summary(model_height_all)
anova(model_height_all, ddf="Satterthwaite", type=3)


res<-residuals(model_height_all)
shapiro.test(res)
qqnorm(res)
qqline(res)
```



## 5) Flight time vs Distance + Height

### Graphs

Height = height of the nest

```{r}
x <- Flights2$Distance
y <- Flights2$Height
z <- Flights2$Flighttime_min

fit <- lm(z ~ x + y, na.action=na.exclude)
x.pred <- seq(min(x[!is.na(x)]), max(x[!is.na(x)]), length.out = 20)
y.pred <- seq(min(y[!is.na(y)]), max(y[!is.na(y)]), length.out = 20)
xy <- expand.grid( x = x.pred, y = y.pred)
z.pred <- matrix(predict(fit, newdata = xy), 
                 nrow = 20, ncol = 20)
fitpoints <- predict(fit)

scatter3D(x, y, z, pch = 19, cex = 0.6, colvar=FALSE, col="dodgerblue3", theta = 40, phi = 15, bty="u", col.panel ="grey93", expand =0.4, col.grid = "white", xlab = "Distance", ylab = "Height", zlab = "Flight time", surf = list(x = x.pred, y = y.pred, z = z.pred,  
facets = TRUE, col=ramp.col(col = c("dodgerblue4", "seagreen2"), n = 100, alpha=0.8), fit = fitpoints, border="black"),main = "Flight time vs Distance + Height")
```

### Model Output

**All data**

```{r}
model_distheight_all<-lm(Flighttime_min ~ Distance + Height , na.action=na.exclude, data=Flights2)
summary(model_distheight_all)
```

Height effect blijkt toch significant. In de negatieve zin weliswaar.
Hoe hoger het nest hoe minder lang hij erover doet. Zou het omgekeerde
verwachten..

**Voorstel: Model volgens Pythagoras?** 

Hoogsignificant
```{r}
model_distheight2_all<-lmer(Flighttime_min ~ sqrt(I(Distance^2) + I(Height^2)) + (1|NestID) + (1|NestID:BaitID) + (1|Individualcode), na.action=na.omit, data=Flights2)
summary(model_distheight2_all)
anova(model_distheight2_all, ddf="Satterthwaite", type=3)
```




## 6) ForagingSpeed vs Cloudcoverage

### Graphs

```{r warning=FALSE}
plot13<-ggplot(Flights2, aes(x=Cloudcoverage_KMI, y=ForagingSpeed)) + geom_point(color="lightblue") + geom_smooth(method="lm", formula =y ~ x, se=TRUE, fullrange=FALSE, level=0.95, color="darkblue") + ggtitle("All data")+ theme(plot.title = element_text(hjust = 0.5, size=10))

plot14<-ggplot(Shortind2_incomplete, aes(x=Cloudcoverage, y=ForagingSpeed)) + geom_point(color="lightblue") + geom_smooth(method="lm", formula =y ~ x, se=TRUE, fullrange=FALSE, level=0.95, color="darkblue") + ggtitle("Shortest per ind.") + theme(plot.title = element_text(hjust = 0.5, size=10))

plot15<-ggplot(Shortpot2_incomplete, aes(x=Cloudcoverage, y=ForagingSpeed)) + geom_point(color="lightblue") + geom_smooth(method="lm", formula =y ~ x,  se=TRUE, fullrange=FALSE, level=0.95, color="darkblue") + ggtitle("Shortest per jar")+ theme(plot.title = element_text(hjust = 0.5, size=10))

ggarrange(plot13, plot14, plot15 + rremove("x.text"), 
          labels = c("A", "B", "C"),
          ncol = 2, nrow = 2)
```


### Model Ouput

**All data** 

Hoogsignificant

Normality ok!


```{r}
model_cloud_all<-lmer(ForagingSpeed ~ Cloudcoverage_KMI + (1|NestID) + (1|NestID:BaitID) + (1|Individualcode), na.action=na.omit, data=Flights2)
summary(model_cloud_all)
anova(model_cloud_all, ddf="Satterthwaite", type=3)

res<-residuals(model_cloud_all)
shapiro.test(res)
qqnorm(res)
qqline(res)
```


## 7) ForagingSpeed vs Weight individual

### Graphs

```{r warning=FALSE}
plot16<-ggplot(Flights2, aes(x=Weight_ind, y=ForagingSpeed)) + geom_point(color="plum") + geom_smooth(method="lm", formula =y ~ x, se=TRUE, fullrange=FALSE, level=0.95, color="darkorchid4") + ggtitle("All data")+ theme(plot.title = element_text(hjust = 0.5, size=10))

plot17<-ggplot(Shortind2_incomplete, aes(x=Weight_ind, y=ForagingSpeed)) + geom_point(color="plum") + geom_smooth(method="lm", formula =y ~ x, se=TRUE, fullrange=FALSE, level=0.95, color="darkorchid4") + ggtitle("Shortest per ind.") + theme(plot.title = element_text(hjust = 0.5, size=10))

plot18<-ggplot(Shortpot2_incomplete, aes(x=Weight_ind, y=ForagingSpeed)) + geom_point(color="plum") + geom_smooth(method="lm", formula =y ~ x,  se=TRUE, fullrange=FALSE, level=0.95, color="darkorchid4") + ggtitle("Shortest per jar")+ theme(plot.title = element_text(hjust = 0.5, size=10))

ggarrange(plot16, plot17, plot18 + rremove("x.text"), 
          labels = c("A", "B", "C"),
          ncol = 2, nrow = 2)
```

### Model Output

**All data** 

Niet significant

Normality ok!

```{r}
model_weight_all<-lmer(ForagingSpeed ~ Weight_ind + (1|NestID) + (1|NestID:BaitID) + (1|Individualcode), na.action=na.omit, data=Flights2)
summary(model_weight_all)
anova(model_weight_all, ddf="Satterthwaite", type=3)

res<-residuals(model_weight_all)
shapiro.test(res)
qqnorm(res)
qqline(res)
```



## 8.1) ForagingSpeed vs Windspeed

### Graphs

Telkens voor de modellen 

ForagingSpeed \~ Windspeed 

ForagingSpeed \~ WindspeedÂ²

```{r warning=FALSE}
plot19<-ggplot(Flights2, aes(x=WindSpeed_KMI, y=ForagingSpeed)) + geom_point(color="khaki3") + geom_smooth(method="lm", formula =y ~ x, se=TRUE, fullrange=FALSE, level=0.95, color="olivedrab") + ggtitle("All data")+ theme(plot.title = element_text(hjust = 0.5, size=10))

plot22<-ggplot(Flights2, aes(x=WindSpeed_KMI, y=ForagingSpeed)) + geom_point(color="khaki3") + geom_smooth(method="lm", formula =y ~ I(x^2), se=TRUE, fullrange=FALSE, level=0.95, color="olivedrab") + ggtitle("All data")+ theme(plot.title = element_text(hjust = 0.5, size=10))


ggarrange(plot19, plot22 + rremove("x.text"), 
          labels = c("A", "B"),
          ncol = 2, nrow = 1)
```

### Model Output

**All data** 
Beide modellen significant

Normality niet ok!

Poisson en log/sqrt werken niet

```{r}
model_wind_all<-lmer(ForagingSpeed ~ WindSpeed_KMI + (1|NestID) + (1|NestID:BaitID) + (1|Individualcode), na.action=na.omit, data=Flights2)
summary(model_wind_all)
anova(model_wind_all, ddf="Satterthwaite", type=3)

model_wind2_all<-lmer(ForagingSpeed ~ I(WindSpeed_KMI^2) + (1|NestID) + (1|NestID:BaitID) + (1|Individualcode), na.action=na.omit, data=Flights2)
summary(model_wind2_all)
anova(model_wind2_all, ddf="Satterthwaite", type=3)


res<-residuals(model_wind_all)
shapiro.test(res)
qqnorm(res)
qqline(res)

res<-residuals(model_wind2_all)
shapiro.test(res)
qqnorm(res)
qqline(res)

```



## 8.2) ForagingSpeed vs Windspeed \| afhankelijk van de windrichting

Hiervoor werd telkens voor elke meting nagegaan of de hoornaar met
meewind (tailwind), tegenwind (upwind) of loodrechte wind
(perpendicular) te maken had. Dit volgens de formules:

\|ðœƒflight âˆ’ðœƒwind\| â‰¤ 45 is tailwind

45 \< \|ðœƒflight âˆ’ðœƒwind\|\<135 is (quasi) perpendicular

\|ðœƒ flight âˆ’ðœƒwind\| â‰¥135 upwind


**Voorstel**
Misschien kan ik tegenwind en meewind samenvoegen aangezien de hoornaar telkens heen en terug vliegt?

### Graphs

```{r}
ggplot(data=subset(Flights2, !is.na(Wind)), aes(x= Wind, col=Wind, y=ForagingSpeed)) + geom_boxplot()

ggplot(data=subset(Flights2, !is.na(Wind)), aes(x= WindSpeed_KMI, col=Wind, y=ForagingSpeed)) + geom_point() + facet_grid(~Wind) + geom_smooth(method="lm", formula = y ~ I(x^2), se=TRUE, fullrange=FALSE, level=0.95)

```


### Model Output

Taiwind licht significant

Upwind significant, maar zeer lage RÂ²

```{r}
data_tailwind<-Flights2 %>%  filter(Wind!="tailwind")
data_perpendicular<-Flights2 %>%  filter(Wind!="perpendicular")
data_upwind<-Flights2 %>%  filter(Wind!="upwind")

model_tailwind<-lmer(ForagingSpeed ~ I(WindSpeed_KMI^2) + (1|NestID) + (1|NestID:BaitID) + (1|Individualcode), na.action=na.omit, data=data_tailwind)
summary(model_tailwind)
anova(model_tailwind, ddf="Satterthwaite", type=3)
```

```{r}
model_perpendicular<-lmer(ForagingSpeed ~ I(WindSpeed_KMI^2) + (1|NestID) + (1|NestID:BaitID) + (1|Individualcode), na.action=na.omit, data=data_perpendicular)
summary(model_perpendicular)
anova(model_perpendicular, ddf="Satterthwaite", type=3)

```

```{r}
model_upwind<-lmer(ForagingSpeed ~ I(WindSpeed_KMI^2) + (1|NestID) + (1|NestID:BaitID) + (1|Individualcode), na.action=na.omit, data=data_upwind)
summary(model_upwind)
anova(model_upwind, ddf="Satterthwaite", type=3)
```





## 9) Flight error vs urbanisation (25m, 50m, 100m)

Flight error is the difference between the actual angle from the bait to
the nest and the flight direction I measured.


### Urbanisatietrajecten

#### Graphs

```{r}
plot28<-ggplot(data=subset(Flights2, !is.na(Observer)), aes(x=Traject25m, y=FlightError)) + geom_point(col="hotpink1") + geom_smooth(method="lm", formula =y ~ x, se=TRUE, fullrange=FALSE, level=0.95, color="violetred4")

plot29<-ggplot(data=subset(Flights2, !is.na(Observer)), aes(x=Traject50m, y=FlightError)) + geom_point(col="hotpink1") + geom_smooth(method="lm", formula =y ~ x , se=TRUE, fullrange=FALSE, level=0.95, color="violetred4")

plot30<-ggplot(data=subset(Flights2, !is.na(Observer)), aes(x=Traject100m, y=FlightError)) + geom_point(col="hotpink1")+ geom_smooth(method="lm", formula =y ~ x, se=TRUE, fullrange=FALSE, level=0.95, color="violetred4")

ggarrange(plot28, plot29, plot30 + rremove("x.text"), 
          labels = c("A", "B", "C"),
          ncol = 2, nrow = 2)
```


#### Model Output

```{r}
model_errurb25<-lmer(FlightError ~ Traject25m + (1|NestID) + (1|NestID:BaitID) + (1|Individualcode), na.action=na.omit, data=data_upwind)
summary(model_errurb25)
anova(model_errurb25, ddf="Satterthwaite", type=3)
```


```{r}
model_errurb50<-lmer(FlightError ~ Traject50m + (1|NestID) + (1|NestID:BaitID) + (1|Individualcode), na.action=na.omit, data=data_upwind)
summary(model_errurb50)
anova(model_errurb50, ddf="Satterthwaite", type=3)
```


```{r}
model_errurb100<-lmer(FlightError ~ Traject100m + (1|NestID) + (1|NestID:BaitID) + (1|Individualcode), na.action=na.omit, data=data_upwind)
summary(model_errurb100)
anova(model_errurb100, ddf="Satterthwaite", type=3)
```



## 10) ForagingSpeed vs Urbanisation

### Graphs

Urbanisatiecirkels niet berekend, meteen trajecten genomen want die zijn
betere maatstaf

#### Alle data

```{r}
plot31<-ggplot(data=subset(Flights2, !is.na(Observer)), aes(x=Traject25m, y=ForagingSpeed)) + geom_point(col="slateblue1") + geom_smooth(method="lm", formula =y ~ x, se=TRUE, fullrange=FALSE, level=0.95, color="slateblue4")
               
plot32<-ggplot(data=subset(Flights2, !is.na(Observer)), aes(x=Traject50m, y=ForagingSpeed)) + geom_point(col="slateblue1") + geom_smooth(method="lm", formula =y ~ x, se=TRUE, fullrange=FALSE, level=0.95, color="slateblue4")

plot33<-ggplot(data=subset(Flights2, !is.na(Observer)), aes(x=Traject100m, y=ForagingSpeed)) + geom_point(col="slateblue1") + geom_smooth(method="lm", formula =y ~ x, se=TRUE, fullrange=FALSE, level=0.95, color="slateblue4")

ggarrange(plot31, plot32, plot33 + rremove("x.text"), 
          labels = c("A", "B", "C"),
          ncol = 2, nrow = 2)
```



### Model Output

**All data**
All significant

```{r}
model_urb25<-lmer(ForagingSpeed ~ Traject25m + (1|NestID) + (1|NestID:BaitID) + (1|Individualcode), na.action=na.omit, data=data_upwind)
summary(model_urb25)
anova(model_urb25, ddf="Satterthwaite", type=3)
```


```{r}
model_urb50<-lmer(ForagingSpeed ~ Traject50m + (1|NestID) + (1|NestID:BaitID) + (1|Individualcode), na.action=na.omit, data=data_upwind)
summary(model_urb50)
anova(model_urb50, ddf="Satterthwaite", type=3)
```


```{r}
model_urb100<-lmer(ForagingSpeed ~ Traject100m + (1|NestID) + (1|NestID:BaitID) + (1|Individualcode), na.action=na.omit, data=data_upwind)
summary(model_urb100)
anova(model_urb100, ddf="Satterthwaite", type=3)
```

```{r}
res<-residuals(model_urb25)
shapiro.test(res)
qqnorm(res)
qqline(res)

res<-residuals(model_urb50)
shapiro.test(res)
qqnorm(res)
qqline(res)

res<-residuals(model_urb100)
shapiro.test(res)
qqnorm(res)
qqline(res)
```







## 11) ForagingSpeed vs Temperatuur + Urbanisation

Aangezien temperatuur en urbanisatie de beste predictoren zijn kunnen we
ze eens samen in een model steken.

```{r}
x <- Flights2$Temperature_KMI
y <- Flights2$Traject100m
z <- Flights2$ForagingSpeed

fit <- lm(z ~ x + y, na.action=na.exclude)
x.pred <- seq(min(x[!is.na(x)]), max(x[!is.na(x)]), length.out = 20)
y.pred <- seq(min(y[!is.na(y)]), max(y[!is.na(y)]), length.out = 20)
xy <- expand.grid( x = x.pred, y = y.pred)
z.pred <- matrix(predict(fit, newdata = xy), 
                 nrow = 20, ncol = 20)
fitpoints <- predict(fit)

scatter3D(x, y, z, pch = 19, cex = 0.6, colvar=FALSE, col="dodgerblue3", theta = 210, phi = 10, bty="u", col.panel ="grey93", expand =0.4, col.grid = "white", xlab = "Temperature_KMI", ylab = "Urbanisation (Traject100m)", zlab = "Flight Speed", surf = list(x = x.pred, y = y.pred, z = z.pred,  
facets = TRUE, col=ramp.col(col = c("dodgerblue4", "seagreen2"), n = 100, alpha=0.8), fit = fitpoints, border="black"),main = "Flight Speed vs Temperature + Urbanisation")
```




```{r}
model_tempurb25<-lmer(ForagingSpeed ~ Temperature_KMI + Traject25m + (1|NestID) + (1|NestID:BaitID) + (1|Individualcode), na.action=na.omit, data=data_upwind)
summary(model_tempurb25)
anova(model_tempurb25, ddf="Satterthwaite", type=3)
```


```{r}
model_tempurb50<-lmer(ForagingSpeed ~ Temperature_KMI + Traject50m + (1|NestID) + (1|NestID:BaitID) + (1|Individualcode), na.action=na.omit, data=data_upwind)
summary(model_tempurb50)
anova(model_tempurb50, ddf="Satterthwaite", type=3)
```


```{r}
model_tempurb100<-lmer(ForagingSpeed ~ Temperature_KMI + Traject100m + (1|NestID) + (1|NestID:BaitID) + (1|Individualcode), na.action=na.omit, data=data_upwind)
summary(model_tempurb100)
anova(model_tempurb100, ddf="Satterthwaite", type=3)
```






# Model Selection 



```{r}

fullmodel<-lmer(ForagingSpeed ~ Traject100m + WindSpeed_KMI + Weight_ind + Temperature_KMI + Cloudcoverage_KMI + (1|NestID) + (1|NestID:BaitID) + (1|Individualcode), na.action=na.omit, data=Flights2)
summary(fullmodel)
anova(fullmodel, ddf="Satterthwaite", type=3)



model1<-lmer(ForagingSpeed ~ Traject100m + WindSpeed_KMI + Temperature_KMI+ Cloudcoverage_KMI + (1|NestID) + (1|NestID:BaitID) + (1|Individualcode), na.action=na.omit, data=Flights2)
summary(model1)

model2<-lmer(ForagingSpeed ~ Traject100m + WindSpeed_KMI + Temperature_KMI + (1|NestID) + (1|NestID:BaitID) + (1|Individualcode), na.action=na.omit, data=Flights2)
summary(model2)

```

```{r}
library(cAIC4)
library(MASS)
library(AICcmodavg)
AIC(signifmodel)

aictab(signifmodel, numberOfSavedModels = 5, direction = "backward", trace = TRUE, data = Flights2)

```


## Statistische modellen probeersels

```{r}
# Model kiezen
library(car)
library(carData)
library(leaps)
select1<-regsubsets(ForagingSpeed ~ Temperature_KMI + Cloudcoverage_KMI + I(WindSpeed_KMI^2) + Weight_ind + Traject100m, na.action=na.exclude, data=Flights2, nbest=3)
summary(select1)
plot(select1, scale="adjr2")

select2<-regsubsets(ForagingSpeed ~ Temperature_KMI + Cloudcoverage_KMI + WindSpeed_KMI + Weight_ind + Traject100m +
Traject100m*Temperature_KMI + Traject100m*Cloudcoverage_KMI + Traject100m*WindSpeed_KMI + Traject100m*Weight_ind + Temperature_KMI*Cloudcoverage_KMI + Temperature_KMI*WindSpeed_KMI + Temperature_KMI*Weight_ind + Cloudcoverage_KMI*WindSpeed_KMI + Cloudcoverage_KMI*Weight_ind + WindSpeed_KMI*Weight_ind, na.action=na.exclude, data=Flights2, nbest=3)
summary(select2)
plot(select2, scale="adjr2")
```


## Multicollinearity check

```{r}
library(ggcorrplot)
library(car)

datacor<-Flights2[, c("Temperature_KMI", "Cloudcoverage_KMI", "WindSpeed_KMI", "Weight_ind", "Traject100m")]
source("~/GitHub/vespa_analyses/Input/HighstatLibV10.R") 
corvif(datacor)

cormat <- round(cor(datacor, use = "pairwise.complete.obs"), 2)
ggcorrplot(cormat, lab= TRUE, type = "lower", ggtheme = ggplot2::theme_gray,
   colors = c("#6D9EC1", "white", "#E46726"))
```



```{r}
plot(Temperature_KMI~Traject100m, data=Flights2)
```


Eerder toeval dat Temperature en Traject100m gecorreleeerd zijn?


##PCA

```{r}
library(vegan)
library(missMDA)
library(FactoMineR)
datapca<-select(Flights2, Cloudcoverage_KMI, WindSpeed_KMI, Temperature_KMI, Weight_ind, Traject100m)
nb <- estim_ncpPCA(datapca, scale = TRUE)
comp<-imputePCA(datapca, ncp=2)
res<-PCA(comp$completeObs)
```
