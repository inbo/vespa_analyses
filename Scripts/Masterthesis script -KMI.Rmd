---
title: "Masterthesis script,weerparameters KMI "
author: "Heleen Van Ransbeeck"
date: "2023-02-27"
output:
  html_document: default
  pdf_document: default
---

# Data inladen

```{r}
Baits<-read.table(file = "~/GitHub/vespa_analyses/Input/Baits_useful.txt", header=TRUE, sep="\t", na.strings=c(""," ","NA"))

Flights<-read.table(file = "~/GitHub/vespa_analyses/Input/Flights_KMI.txt", header=TRUE, sep="\t", na.strings=c(""," ","NA"))

Nests<-read.table(file = "~/GitHub/vespa_analyses/Input/Nests_useful.txt", header=TRUE, sep="\t", na.strings=c(""," ","NA"))

Shortind_incomplete<-read.table(file = "~/GitHub/vespa_analyses/Input/Shortind_incomplete.txt", header=TRUE, sep="\t", na.strings=c(""," ","NA"))

Shortpot_incomplete<-read.table(file = "~/GitHub/vespa_analyses/Input/Shortpot_incomplete.txt", header=TRUE, sep="\t", na.strings=c(""," ","NA"))

Individuals<-read.table(file = "~/GitHub/vespa_analyses/Input/Individuals.txt", header=TRUE, sep="\t", na.strings=c(""," ","NA"))

```


# Aanpassingen datasets

```{r}
# Overbodige kolommen wegdoen, foutje in excel
Flights<-Flights[1:(length(Flights)-1)]
Shortind_incomplete<-Shortind_incomplete[1:(length(Shortind_incomplete)-2)]
Shortpot_incomplete<-Shortpot_incomplete[1:(length(Shortpot_incomplete)-2)]

#Foerageersnelheid en vliegsnelheid (m/s) toevoegen aan tabel
Flights$test_rule_of_thumb<-Flights$Distance/(Flights$Flighttime_min*60)
Shortind_incomplete$test_rule_of_thumb<-Shortind_incomplete$Distance/(Shortind_incomplete$Flighttime_min*60)
Shortpot_incomplete$test_rule_of_thumb<-Shortpot_incomplete$Distance/(Shortpot_incomplete$Flighttime_min*60)

Flights$ForagingSpeed<-Flights$Distance*2/(Flights$Flighttime_min*60)
Shortind_incomplete$ForagingSpeed<-Shortind_incomplete$Distance*2/(Shortind_incomplete$Flighttime_min*60)
Shortpot_incomplete$ForagingSpeed<-Shortpot_incomplete$Distance*2/(Shortpot_incomplete$Flighttime_min*60)


## Urbanisatiecirkels per vliegtijd toevoegen
Flights<-merge(Flights, Baits[, c("NestID", "BaitID", "Urbanisation25m", "Urbanisation50m", "Urbanisation100m")], by=c("NestID", "BaitID"), all=TRUE)
Shortind_incomplete<-merge(Shortind_incomplete, Baits[, c("NestID", "BaitID", "Urbanisation25m", "Urbanisation50m", "Urbanisation100m")], by=c("NestID", "BaitID"))
Shortpot_incomplete<-merge(Shortpot_incomplete, Baits[, c("NestID", "BaitID", "Urbanisation25m", "Urbanisation50m", "Urbanisation100m")], by=c("NestID", "BaitID"))

## Urbanisatietrajecten per vliegtijd toevoegen
Flights<-merge(Flights, Baits[, c("NestID", "BaitID", "Traject25m", "Traject50m", "Traject100m")], by=c("NestID", "BaitID"), all=TRUE)
Shortind_incomplete<-merge(Shortind_incomplete, Baits[, c("NestID", "BaitID", "Traject25m", "Traject50m", "Traject100m")], by=c("NestID", "BaitID"))
Shortpot_incomplete<-merge(Shortpot_incomplete, Baits[, c("NestID", "BaitID", "Traject25m", "Traject50m", "Traject100m")], by=c("NestID", "BaitID"))

## Gewicht individu per vliegtijd toevoegen
Flights<-merge(Flights, Individuals[, c("NestID", "BaitID","ColorInd", "Weight_ind")], by=c("NestID", "BaitID", "ColorInd"), all=TRUE)
Shortind_incomplete<-merge(Shortind_incomplete, Individuals[, c("NestID", "BaitID", "ColorInd", "Weight_ind")], by=c("NestID", "BaitID", "ColorInd"))
Shortpot_incomplete<-merge(Shortpot_incomplete, Individuals[, c("NestID", "BaitID", "ColorInd","Weight_ind")], by=c("NestID", "BaitID", "ColorInd"))

## Nesthoogte per vliegtijd toevoegen
Flights<-merge(Flights, Nests[, c("NestID", "Height")], by=c("NestID"), all=TRUE)
Shortind_incomplete<-merge(Shortind_incomplete, Nests[, c("NestID", "Height")], by=c("NestID"))
Shortpot_incomplete<-merge(Shortpot_incomplete, Nests[, c("NestID", "Height")], by=c("NestID"))

library(ggplot2)
library(ggpubr)
```

Volgende datasets zijn gecreëerd:

- Flights: dataset met alle vliegtijden
- Shortind_incomplete: dataset met kortste vliegtijden per individu
- Shortpot_incomplete: dataset met kortste vliegtijden per wiekpot


Voor het model: *Flight time ~ Distance*
gebruiken we de dataset vliegtijden per individu
Omdat we hiermee de theoretische regel 1min=100m kunnen verifiëren.
De imkers nemen hiervoor altijd kortste meting

Voor modellen met *weerparameters, gewicht, urbanisatie*:
Hiervoor nemen we telkens de hele dataset, omdat elke meting van deze 
factoren afhangt.



# Datapunten op 2km weglaten

**We gaan verder met de dataset zonder de outliers in Melle**

```{r}
library(dplyr)
Flights2<-Flights %>%  filter(NestID!=1)
Shortind2_incomplete<-Shortind_incomplete %>%  filter(NestID!=1)
Shortpot2_incomplete<-Shortpot_incomplete %>%  filter(NestID!=1)

# ID maken per individu
Flights2$Individualcode <- paste(Flights2$NestID, Flights2$BaitID,Flights2$ColorInd, sep="_")
Shortind2_incomplete$Individualcode <- paste(Shortind2_incomplete$NestID, Shortind2_incomplete$BaitID,Shortind2_incomplete$ColorInd, sep="_")

```





**VRAAG:** Hoe grafiek maken van parameters mixed model?


# 1.1) ForagingSpeed vs Temperature

## Graphs

```{r echo=FALSE, warning=FALSE}
ggplot(Flights2, aes(x=Temperature_KMI, y=ForagingSpeed)) + geom_point(color="lightcoral") + geom_smooth(method="lm", formula =y ~ x, se=TRUE, fullrange=FALSE, level=0.95, color="orangered3") + ggtitle("All data KMI")+ theme(plot.title = element_text(hjust = 0.5, size=10))

```

## Model Output


- Normality niet ok!

- Niet significant!

```{r}
library(lmerTest)
library(lme4)

model_temp_all<-lmer(ForagingSpeed ~ Temperature_KMI + (1|NestID) + (1|NestID:BaitID) + (1|Individualcode), na.action=na.omit, data=Flights2)
summary(model_temp_all)
anova(model_temp_all, ddf="Satterthwaite", type=3)

res<-residuals(model_temp_all)
shapiro.test(res)
qqnorm(res)
qqline(res)
```



# 1.2) Flight time vs Distance + Temperature

## Graph

**Klopt dit? Kan dit ook met mixed model?**

```{r}
library(knitr)
library(kableExtra)
library("plot3D")

x <- Flights2$Distance
y <- Flights2$Temperature_KMI
z <- Flights2$Flighttime_min

fit <- lm(z ~ x + y, na.action=na.exclude)
x.pred <- seq(min(x[!is.na(x)]), max(x[!is.na(x)]), length.out = 20)
y.pred <- seq(min(y[!is.na(y)]), max(y[!is.na(y)]), length.out = 20)
xy <- expand.grid( x = x.pred, y = y.pred)
z.pred <- matrix(predict(fit, newdata = xy), 
                 nrow = 20, ncol = 20)
fitpoints <- predict(fit)

scatter3D(x, y, z, pch = 19, cex = 0.6, colvar=FALSE, col="dodgerblue3", theta = 210, phi = 10, bty="u", col.panel ="grey93", expand =0.4, col.grid = "white", xlab = "Distance", ylab = "Temperature", zlab = "Flight time", surf = list(x = x.pred, y = y.pred, z = z.pred,  
facets = TRUE, col=ramp.col(col = c("dodgerblue4", "seagreen2"), n = 100, alpha=0.8), fit = fitpoints, border="black"),main = "Flight time vs Distance + Temperature")
```


**Met plotly**

Had met deze link problemen met expand.grid
https://stackoverflow.com/questions/38331198/add-regression-plane-to-3d-scatter-plot-in-plotly
Dan maar grid dat van hierboven gebruikt, maar nu klopt er precies iets niet?
Alle datapunten liggen boven het oppervlak.

```{r}
library(plotly)
library(tidyverse)
FlightsNoNA<-Flights2 %>%  filter(Flighttime_min!="NA")
FlightsNoNA<-FlightsNoNA %>%  filter(Temperature_KMI!="NA")

fig <- plot_ly(FlightsNoNA, x = ~Distance, y = ~Temperature_KMI, z = ~Flighttime_min, size=1)
fig <- fig %>% add_markers()
fig <- fig %>% layout(scene = list(xaxis = list(title = 'Distance'),
                     yaxis = list(title = 'Temperature_KMI'),
                     zaxis = list(title = 'Flight time (min)')))
p2 <- add_trace(p = fig,
                z = z.pred,
                x = seq(2100, 0, by = -100),
                y = seq(0, 30, by = 10),
                type = "surface")
p2
```



## Model Ouput

- Normality niet ok!

- Niet significant

```{r}
model_tempdist_all<-lmer(Flighttime_min ~ Distance + Temperature_KMI + (1|NestID) + (1|NestID:BaitID) + (1|Individualcode), na.action=na.exclude, data=Flights2)
summary(model_tempdist_all)
anova(model_tempdist_all, ddf="Satterthwaite", type=3)

res<-residuals(model_tempdist_all)
shapiro.test(res)
qqnorm(res)
qqline(res)
```





# 2) ForagingSpeed vs Cloudcoverage

## Graphs

```{r warning=FALSE}
ggplot(Flights2, aes(x=Cloudcoverage_KMI, y=ForagingSpeed)) + geom_point(color="lightblue") + geom_smooth(method="lm", formula =y ~ x, se=TRUE, fullrange=FALSE, level=0.95, color="darkblue") + ggtitle("All data KMI")+ theme(plot.title = element_text(hjust = 0.5, size=10))
```


## Model Ouput

- Licht significant

- Normality niet ok!


```{r}
model_cloud_all<-lmer(ForagingSpeed ~ Cloudcoverage_KMI + (1|NestID) + (1|NestID:BaitID) + (1|Individualcode), na.action=na.omit, data=Flights2)
summary(model_cloud_all)
anova(model_cloud_all, ddf="Satterthwaite", type=3)

res<-residuals(model_cloud_all)
shapiro.test(res)
qqnorm(res)
qqline(res)
```







# 3.1) ForagingSpeed vs Windspeed

## Graphs

Telkens voor de modellen: 

ForagingSpeed \~ Windspeed 

ForagingSpeed \~ Windspeed²

```{r warning=FALSE}
plot19<-ggplot(Flights2, aes(x=WindSpeed_KMI, y=ForagingSpeed)) + geom_point(color="khaki3") + geom_smooth(method="lm", formula =y ~ x, se=TRUE, fullrange=FALSE, level=0.95, color="olivedrab") + ggtitle("ForagingSpeed ~ Windspeed  KMI")+ theme(plot.title = element_text(hjust = 0.5, size=10))

plot22<-ggplot(Flights2, aes(x=WindSpeed_KMI, y=ForagingSpeed)) + geom_point(color="khaki3") + geom_smooth(method="lm", formula =y ~ I(x^2), se=TRUE, fullrange=FALSE, level=0.95, color="olivedrab") + ggtitle("ForagingSpeed ~ Windspeed²  KMI")+ theme(plot.title = element_text(hjust = 0.5, size=10))


ggarrange(plot19, plot22 + rremove("x.text"), 
          labels = c("A", "B"),
          ncol = 2, nrow = 1)
```

## Model Output


- Beide modellen hoogsignificant

- Normality voor beiden ok!

```{r}
model_wind_all<-lmer(ForagingSpeed ~ WindSpeed_KMI + (1|NestID) + (1|NestID:BaitID) + (1|Individualcode), na.action=na.omit, data=Flights2)
summary(model_wind_all)
anova(model_wind_all, ddf="Satterthwaite", type=3)

model_wind2_all<-lmer(ForagingSpeed ~ I(WindSpeed_KMI^2) + (1|NestID) + (1|NestID:BaitID) + (1|Individualcode), na.action=na.omit, data=Flights2)
summary(model_wind2_all)
anova(model_wind2_all, ddf="Satterthwaite", type=3)


res<-residuals(model_wind_all)
shapiro.test(res)
qqnorm(res)
qqline(res)

res<-residuals(model_wind2_all)
shapiro.test(res)
qqnorm(res)
qqline(res)

```



# 3.2) ForagingSpeed vs Windspeed \| afhankelijk van de windrichting

Hiervoor werd telkens voor elke meting nagegaan of de hoornaar met
meewind (tailwind), tegenwind (upwind) of loodrechte wind
(perpendicular) te maken had. Dit volgens de formules:

\|𝜃flight −𝜃wind\| ≤ 45 is tailwind

45 \< \|𝜃flight −𝜃wind\|\<135 is (quasi) perpendicular

\|𝜃 flight −𝜃wind\| ≥135 upwind



## Graphs

```{r}
ggplot(data=subset(Flights2, !is.na(Wind)), aes(x= Wind, col=Wind, y=ForagingSpeed)) + geom_boxplot()

ggplot(data=subset(Flights2, !is.na(Wind)), aes(x= WindSpeed_KMI, col=Wind, y=ForagingSpeed)) + geom_point() + facet_grid(~Wind) + geom_smooth(method="lm", formula = y ~ I(x^2), se=TRUE, fullrange=FALSE, level=0.95)

```



## Model Output

### Anova van Foragingspeed en de 3 windinvloeden

- interpretatie?

```{r}
windanova<-lmer(ForagingSpeed ~ Wind + (1|NestID) + (1|NestID:BaitID) + (1|Individualcode), na.action=na.exclude, data=Flights2)
summary(windanova)
```


### ForagingSpeed vs WindSpeed voor Tailwind dataset

- Hoogsignificant 

- Normality ok!

```{r}
data_tailwind<-Flights2 %>%  filter(Wind!="tailwind")

model_tailwind<-lmer(ForagingSpeed ~ WindSpeed_KMI + (1|NestID) + (1|NestID:BaitID) + (1|Individualcode), na.action=na.omit, data=data_tailwind)
summary(model_tailwind)
anova(model_tailwind, ddf="Satterthwaite", type=3)

res<-residuals(model_tailwind)
shapiro.test(res)
qqnorm(res)
qqline(res)
```


### ForagingSpeed vs WindSpeed voor Perpendicular dataset

- Niet significant

- Normality niet ok!

```{r}
data_perpendicular<-Flights2 %>%  filter(Wind!="perpendicular")

model_perpendicular<-lmer(ForagingSpeed ~ WindSpeed_KMI + (1|NestID) + (1|NestID:BaitID) + (1|Individualcode), na.action=na.omit, data=data_perpendicular)
summary(model_perpendicular)
anova(model_perpendicular, ddf="Satterthwaite", type=3)

res<-residuals(model_perpendicular)
shapiro.test(res)
qqnorm(res)
qqline(res)
```


### ForagingSpeed vs WindSpeed voor Upwind dataset

- Hoogsignificant

- Normality ok!

```{r}
data_upwind<-Flights2 %>%  filter(Wind!="upwind")

model_upwind<-lmer(ForagingSpeed ~ WindSpeed_KMI + (1|NestID) + (1|NestID:BaitID) + (1|Individualcode), na.action=na.omit, data=data_upwind)
summary(model_upwind)
anova(model_upwind, ddf="Satterthwaite", type=3)

res<-residuals(model_upwind)
shapiro.test(res)
qqnorm(res)
qqline(res)
```




# Model Selection 

```{r}
fullmodel<-lmer(ForagingSpeed ~ Traject100m + WindSpeed_KMI + Temperature_KMI + Cloudcoverage_KMI + Weight_ind + (1|NestID) + (1|NestID:BaitID) + (1|Individualcode), na.action=na.omit, data=Flights2)
summary(fullmodel)


model1<-lmer(ForagingSpeed ~ Traject100m + WindSpeed_KMI + Temperature_KMI + Cloudcoverage_KMI + (1|NestID) + (1|NestID:BaitID) + (1|Individualcode), na.action=na.omit, data=Flights2)
summary(model1)

model2<-lmer(ForagingSpeed ~ Traject100m + WindSpeed_KMI + Cloudcoverage_KMI + (1|NestID) + (1|NestID:BaitID) + (1|Individualcode), na.action=na.omit, data=Flights2)
summary(model2)

model3<-lmer(ForagingSpeed ~ Traject100m + WindSpeed_KMI + (1|NestID) + (1|NestID:BaitID) + (1|Individualcode), na.action=na.omit, data=Flights2)
summary(model3)
```
```{r}
library(cAIC4)
library(MASS)
library(AICcmodavg)
AIC(fullmodel)
AIC(model1)
AIC(model2)
AIC(model3)
```

